<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ì„±ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { margin:0; padding:15px; background:white!important; font-size:13px; line-height:1.4; }
            .print-bg { background:white!important; box-shadow:none!important; }
            .text-4xl{font-size:26px!important; margin-bottom:10px!important;}
            .text-xl{font-size:16px!important; margin-bottom:18px!important;}
            .text-3xl{font-size:18px!important;}
            .text-2xl{font-size:16px!important;}
            .text-lg{font-size:14px!important;}
            .text-sm{font-size:11px!important;}
            .text-xs{font-size:10px!important;}
            .mb-8{margin-bottom:18px!important;} .mb-6{margin-bottom:15px!important;}
            .mb-4{margin-bottom:12px!important;} .mb-3{margin-bottom:10px!important;}
            .mb-2{margin-bottom:8px!important;} .p-6{padding:15px!important;}
            .gap-8{gap:15px!important;} .gap-6{gap:12px!important;}
            .shadow-lg{box-shadow:none!important;}
            .rounded-lg{border-radius:6px!important; border:1px solid #d1d5db;}
            .stats-grid{display:flex!important; flex-direction:row!important; gap:10px!important; margin-bottom:18px!important;}
            .stats-card{flex:1!important; min-width:0!important; text-align:center!important; padding:12px 10px!important; border:1px solid #d1d5db!important; border-radius:6px!important; background:white!important;}
            .line-chart-container{height:220px!important; margin-bottom:18px!important; padding:10px!important;}
            .chart-container{height:180px!important; margin-bottom:12px!important; padding:5px!important;}
            .pie-charts-grid{display:flex!important; gap:12px!important; margin-bottom:18px!important;}
            .pie-chart-card{flex:1!important; padding:12px!important; border:1px solid #d1d5db!important; border-radius:6px!important; min-height:240px!important;}
            .summary-grid{display:flex!important; gap:15px!important;}
            .summary-column{flex:1!important;}
            .no-break{page-break-inside:avoid!important;}
        }
        .star{color:#fbbf24;} .chart-container{position:relative; height:300px;}
    </style>
</head>
<body class="bg-gray-100">
<div id="app"></div>

<script>
let appState = { studentName:'', rawData:'', parsedData:[], showPreview:false, shareUrl:'', showShareUrl:false };

function loadFromURL() {
    const urlParams=new URLSearchParams(window.location.search);
    const reportData=urlParams.get('report'); const reportId=urlParams.get('id');
    try{
        let decodedData;
        if(reportId){
            const storedData=localStorage.getItem(reportId);
            if(storedData) decodedData=JSON.parse(storedData); else return;
        }else if(reportData){
            decodedData=JSON.parse(atob(reportData));
        }else return;

        if(decodedData.n && decodedData.d){
            appState.studentName=decodedData.n;
            appState.parsedData=decompressData(decodedData.d);
        }else{
            appState.studentName=decodedData.studentName;
            appState.parsedData=decodedData.parsedData;
        }
        appState.showPreview=true;
    }catch(e){ alert('ë§í¬ê°€ ì†ìƒë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
}

function parseNotionData(text){
    const lines = text.trim().split('\n');
    const data = [];

    lines.forEach(line => {
        const parts = line.split(/\t+/).map(p => p ? p.trim() : '');
        const date = parts[0] || '';
        const attendance = parts[1] || '';
        const wordScore = parts[2] || '';
        const totalWords = parts[3] || '';
        const retest = parts[4] || '';
        const homeworkRaw = parts[5] || '';
        const attitudeRaw = parts[6] || '';

        const isAbsent = attendance === 'ê²°ì„';

        // ìˆ™ì œ ì²˜ë¦¬
        let homework = null;      // í†µê³„ìš© ìˆ«ì
        let homeworkDisplay = ''; // í™”ë©´ í‘œì‹œìš©

        if (!isAbsent) {
            if (homeworkRaw.includes('â˜…')) {
                // ë³„ì 
                homework = (homeworkRaw.match(/â˜…/g) || []).length;
                homeworkDisplay = 'â˜…'.repeat(homework) + 'â˜†'.repeat(3 - homework);
            } else if (homeworkRaw === 'ë¯¸ì œì¶œ') {
                homework = 0;           // í†µê³„ìš© 0
                homeworkDisplay = 'ë¯¸ì œì¶œ';
            } else if (homeworkRaw === 'ì§€ë‚œ ì‹œê°„ì—ëŠ” ìˆ™ì œê°€ ì—†ì—ˆìŠµë‹ˆë‹¤.') {
                homework = null;        // í†µê³„ ì œì™¸
                homeworkDisplay = '';   // í™”ë©´ì—ë„ í‘œì‹œ X
            } else {
                homework = null;        // ì•Œ ìˆ˜ ì—†ëŠ” ê°’ë„ ì œì™¸
                homeworkDisplay = homeworkRaw || '';
            }
        }

        // íƒœë„ ì²˜ë¦¬
        let attitude = null;
        if (!isAbsent && attitudeRaw.includes('â˜…')) {
            attitude = (attitudeRaw.match(/â˜…/g) || []).length;
        }

        if(date && attendance){
            data.push({
                date,
                attendance,
                wordScore: !isAbsent && wordScore ? parseInt(wordScore) : null,
                totalWords: !isAbsent && totalWords ? parseInt(totalWords) : null,
                retest: !isAbsent && retest.includes('ì¬ì‹œí—˜') ? 'ì¬ì‹œí—˜' : '',
                homework,
                homeworkDisplay, // í™”ë©´ í‘œì‹œìš©
                attitude
            });
        }
    });

    return data.reverse();
}


function calculateStats(parsedData){
    const totalClasses=parsedData.length;
    const attendanceCount=parsedData.filter(d=>d.attendance==='ì¶œì„').length;
    const lateCount=parsedData.filter(d=>d.attendance==='ì§€ê°').length;
    const absentCount=parsedData.filter(d=>d.attendance==='ê²°ì„').length;
    const attendanceRate=(((attendanceCount+lateCount)/totalClasses)*100).toFixed(1);
    const retestCount=parsedData.filter(d=>d.retest==='ì¬ì‹œí—˜').length;

    const chartData=parsedData.map((item,index)=>{
        const accuracy=(item.wordScore!==null && item.totalWords>0)? (item.wordScore/item.totalWords*100):null;
        return {...item, day:index+1, accuracy, shortDate:item.date.substring(5)};
    }).filter(item=>item.accuracy!==null);

    const averageAccuracy=chartData.length>0? chartData.reduce((s,i)=>s+i.accuracy,0)/chartData.length : 0;

    return {totalClasses, attendanceCount, lateCount, absentCount, attendanceRate, retestCount, averageAccuracy, chartData};
}

function compressData(data){
    return data.map(item=>({d:item.date.substring(5), a:item.attendance==='ì¶œì„'?1: item.attendance==='ì§€ê°'?2:3, w:item.wordScore, t:item.totalWords, r:item.retest==='ì¬ì‹œí—˜'?1:0, h:item.homework, at:item.attitude}));
}
function decompressData(compressed){
    const y=new Date().getFullYear();
    return compressed.map(item=>({date:`${y}/${item.d}`, attendance:item.a===1?'ì¶œì„': item.a===2?'ì§€ê°':'ê²°ì„', wordScore:item.w, totalWords:item.t, retest:item.r===1?'ì¬ì‹œí—˜':'', homework:item.h, attitude:item.at }));
}

function createCharts(stats){
    setTimeout(()=>{
        const lineCtx=document.getElementById('lineChart');
        if(lineCtx && stats.chartData.length>0){
            new Chart(lineCtx,{type:'line', data:{
                labels:stats.chartData.map(i=>i.shortDate),
                datasets:[{label:'ì •ë‹µë¥  (%)', data:stats.chartData.map(i=>i.accuracy), borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.1)', tension:0.3, pointBackgroundColor:'#3b82f6', pointRadius:4}]
            }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{font:{size:12}}}}, scales:{x:{ticks:{font:{size:10}}}, y:{beginAtZero:true,max:100,ticks:{font:{size:10}}}}}});
        }
        const pie=(ctxId,data)=>{ if(!data.length) return; const ctx=document.getElementById(ctxId); if(!ctx)return;
            new Chart(ctx,{type:'pie', data:{labels:data.map(i=>i.label), datasets:[{data:data.map(i=>i.value), backgroundColor:data.map(i=>i.color)}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{font:{size:11}, padding:10}}}}});
        };
        pie('attendanceChart',[{label:'ì¶œì„',value:stats.attendanceCount,color:'#10b981'},{label:'ì§€ê°',value:stats.lateCount,color:'#f59e0b'},{label:'ê²°ì„',value:stats.absentCount,color:'#ef4444'}].filter(i=>i.value>0));
        const hw=appState.parsedData.filter(d=>d.homework!==null);
        pie('homeworkChart',[{label:'ë¯¸í¡ (â˜…â˜†â˜†)',value:hw.filter(d=>d.homework===1).length,color:'#ef4444'},{label:'ë³´í†µ (â˜…â˜…â˜†)',value:hw.filter(d=>d.homework===2).length,color:'#f59e0b'},{label:'ìš°ìˆ˜ (â˜…â˜…â˜…)',value:hw.filter(d=>d.homework===3).length,color:'#10b981'}].filter(i=>i.value>0));
        const att=appState.parsedData.filter(d=>d.attitude!==null);
        pie('attitudeChart',[{label:'ë¯¸í¡ (â˜…â˜†â˜†)',value:att.filter(d=>d.attitude===1).length,color:'#ef4444'},{label:'ë³´í†µ (â˜…â˜…â˜†)',value:att.filter(d=>d.attitude===2).length,color:'#f59e0b'},{label:'ìš°ìˆ˜ (â˜…â˜…â˜…)',value:att.filter(d=>d.attitude===3).length,color:'#10b981'}].filter(i=>i.value>0));
    },100);
}

function createStatCard(icon,title,value,subtext,color){
    return `<div class="bg-white rounded-lg shadow-lg p-6 text-center stats-card"><div class="text-${color}-500 mb-3">${icon}</div><h3 class="text-lg font-semibold text-gray-700">${title}</h3><p class="text-3xl font-bold text-${color}-600">${value}</p><p class="text-sm text-gray-500">${subtext||''}</p></div>`;
}
function createPieChartBox(title,canvasId){
    return `<div class="bg-white rounded-lg shadow-lg p-6 pie-chart-card"><h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">${title}</h3><div class="chart-container"><canvas id="${canvasId}"></canvas></div></div>`;
}

function renderReport(stats){
    const summaryCards=`
        ${createStatCard('ğŸ“…','ì¶œì„ë¥ ',`${stats.attendanceRate}%`,`${stats.attendanceCount+stats.lateCount}/${stats.totalClasses}ì¼`,'blue')}
        ${createStatCard('ğŸ“ˆ','í‰ê·  ì •ë‹µë¥ ',`${stats.averageAccuracy.toFixed(1)}%`,'ë‹¨ì–´ í…ŒìŠ¤íŠ¸','green')}
        ${createStatCard(stats.retestCount>5?'âš ï¸':'ğŸ“š','ì¬ì‹œí—˜ íšŸìˆ˜',`${stats.retestCount}íšŒ`,stats.retestCount>5?'ê°œì„  í•„ìš”':'ì–‘í˜¸',stats.retestCount>5?'red':'blue')}
        ${createStatCard('ğŸ†','ì¢…í•© í‰ê°€',stats.overallGrade,stats.overallComment,'purple')}
    `;
    const pieCharts=`
        ${createPieChartBox('ì¶œì„ í˜„í™©','attendanceChart')}
        ${createPieChartBox('ìˆ˜ì—… íƒœë„','attitudeChart')}
        ${createPieChartBox('ìˆ™ì œ ì´í–‰','homeworkChart')}
    `;
    return `
    <div class="no-print fixed top-4 right-4 z-50 space-y-2 bg-white/80 backdrop-blur shadow-lg rounded-lg p-3">
        <div class="flex flex-wrap gap-2">
            <button onclick="resetForm()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                ğŸ”„ ìƒˆ ë¦¬í¬íŠ¸ ì‘ì„±
            </button>
            <button onclick="window.print()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 text-lg font-semibold">
                ğŸ“„ PDFë¡œ ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 p-6 print-bg">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">í•™ê¸°ë§ ì„±ê³¼ ë¦¬í¬íŠ¸</h1>
                <p class="text-xl text-gray-600">${appState.studentName} í•™ìƒ â€¢ 2025ë…„ 1í•™ê¸°</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 stats-grid no-break">${summaryCards}</div>
            ${stats.chartData.length>0? `<div class="bg-white rounded-lg shadow-lg p-6 mb-8 no-break"><h3 class="text-xl font-semibold text-gray-800 mb-4">ë‹¨ì–´ í…ŒìŠ¤íŠ¸ ì •ë‹µë¥  ì¶”ì´</h3><div class="chart-container line-chart-container"><canvas id="lineChart"></canvas></div></div>`:''}
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8 pie-charts-grid no-break">${pieCharts}</div>
            <div class="bg-white rounded-lg shadow-lg p-6 no-break">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">í•™ê¸° ì´í‰</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 summary-grid">
                    <div class="summary-column">
                        <h4 class="font-semibold text-gray-700 mb-3 text-green-600">ê°•ì </h4>
                        <div class="space-y-2 text-gray-700 text-sm">
                            ${stats.attendanceRate>=90? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-3"></span>ìš°ìˆ˜í•œ ì¶œì„ë¥  (${stats.attendanceRate}%)</p>`:''}
                            <p class="flex items-center"><span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-3"></span>ê¾¸ì¤€í•œ ìˆ˜ì—… ì°¸ì—¬</p>
                        </div>
                    </div>
                    <div class="summary-column">
                        <h4 class="font-semibold text-gray-700 mb-3 text-red-600">ê°œì„  í•„ìš”ì‚¬í•­</h4>
                        <div class="space-y-2 text-gray-700 text-sm">
                            ${stats.retestCount>3? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-3"></span>ì¬ì‹œí—˜ íšŸìˆ˜ ì¤„ì´ê¸° (${stats.retestCount}íšŒ)</p>`:''}
                            ${stats.lateCount>0? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-3"></span>ì§€ê° íšŸìˆ˜ ì¤„ì´ê¸° (${stats.lateCount}íšŒ)</p>`:''}
                            ${stats.averageAccuracy<80? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-3"></span>ì˜ˆìŠµÂ·ë³µìŠµì„ í†µí•œ í•™ìŠµ ë³´ì™„</p>`:''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function render(){
    const app=document.getElementById('app');
    if(appState.showPreview){
        const stats=calculateStats(appState.parsedData);
        stats.overallGrade=stats.averageAccuracy>=85? 'ìš°ìˆ˜': stats.averageAccuracy>=70?'ë³´í†µ':'ë…¸ë ¥';
        stats.overallComment=stats.averageAccuracy>=85? 'ë§¤ìš° ìš°ìˆ˜í•¨': stats.averageAccuracy>=70?'ê¾¸ì¤€íˆ í–¥ìƒ ì¤‘':'ê°œì„  í•„ìš”';
        app.innerHTML=renderReport(stats);
        createCharts(stats);
    }else{
        app.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 p-6">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">í•™ìƒ ì„±ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</h1>
                    <p class="text-xl text-gray-600">ë…¸ì…˜ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì—¬ ìë™ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ ì´ë¦„</label>
                            <input type="text" id="studentNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: í™ê¸¸ë™">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë…¸ì…˜ ë°ì´í„° (ë³µì‚¬-ë¶™ì—¬ë„£ê¸°)</label>
                            <textarea id="rawDataInput" class="w-full h-64 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm" placeholder="ì˜ˆ:
2025/08/04	ì¶œì„	8	8		â˜…â˜…â˜…	â˜…â˜…â˜…
2025/08/01	ì¶œì„	19	25	ì¬ì‹œí—˜	â˜…â˜…â˜…	â˜…â˜…â˜…
2025/07/25	ì¶œì„	24	25		â˜…â˜…â˜…	â˜…â˜…â˜…"></textarea>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button onclick="handleSubmit()" class="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">ğŸ‘ï¸ ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">ìƒ˜í”Œ ë°ì´í„° (í…ŒìŠ¤íŠ¸ìš©)</h3>
                        <button onclick="loadSampleData()" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>`;
    }
}

function handleSubmit(){
    const studentName=document.getElementById('studentNameInput').value;
    const rawData=document.getElementById('rawDataInput').value;
    if(!studentName.trim()){alert('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
    if(!rawData.trim()){alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
    const parsed=parseNotionData(rawData);
    if(parsed.length===0){alert('ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');return;}
    appState.studentName=studentName; appState.rawData=rawData; appState.parsedData=parsed; appState.showPreview=true; render();
}
function resetForm(){ appState={studentName:'', rawData:'', parsedData:[], showPreview:false, shareUrl:'', showShareUrl:false}; window.history.pushState({}, document.title, window.location.pathname); render();}
function loadSampleData() {
    document.getElementById('studentNameInput').value = 'í™ê¸¸ë™';
    document.getElementById('rawDataInput').value = `2025/08/05	ì§€ê°	18	20		â˜…â˜…â˜†	â˜…â˜…â˜…
2025/07/24	ì§€ê°	6	14	ì¬ì‹œí—˜	â˜…â˜…â˜…	â˜…â˜…â˜…
2025/07/22	ì¶œì„	20	20		â˜…â˜†â˜†	â˜…â˜…â˜…
2025/07/17	ì¶œì„	5	14	ì¬ì‹œí—˜	â˜…â˜…â˜†	â˜…â˜…â˜…
2025/07/15	ì¶œì„	8	20	ì¬ì‹œí—˜	â˜…â˜†â˜†	â˜…â˜…â˜…
2025/07/10	ì¶œì„	7	14	ì¬ì‹œí—˜	â˜…â˜…â˜†	â˜…â˜…â˜…
2025/07/08	ì¶œì„	18	20		â˜…â˜†â˜†	â˜…â˜…â˜†
2025/07/03	ì¶œì„	14	14		â˜…â˜…â˜…	â˜…â˜…â˜…
2025/07/01	ê²°ì„					
2025/06/26	ì¶œì„	14	14		â˜…â˜…â˜…	â˜…â˜…â˜…
2025/06/24	ì¶œì„	13	20	ì¬ì‹œí—˜	â˜…â˜†â˜†	â˜…â˜…â˜†
2025/06/19	ì¶œì„	10	13	ì¬ì‹œí—˜	â˜…â˜…â˜†	â˜…â˜…â˜…
2025/06/17	ì¶œì„	10	20	ì¬ì‹œí—˜	â˜…â˜†â˜†	â˜…â˜…â˜…
2025/06/12	ì¶œì„	2	13	ì¬ì‹œí—˜	â˜…â˜…â˜…	â˜…â˜…â˜†
2025/06/10	ì¶œì„	17	20		â˜…â˜†â˜†	â˜…â˜…â˜…
2025/06/05	ì¶œì„	14	14		â˜…â˜†â˜†	â˜…â˜…â˜…
2025/06/03	ì¶œì„				ì§€ë‚œ ì‹œê°„ì—ëŠ” ìˆ™ì œê°€ ì—†ì—ˆìŠµë‹ˆë‹¤.	â˜…â˜…â˜…`;
}
window.onload=function(){ loadFromURL(); render(); };
</script>
</body>
</html>
