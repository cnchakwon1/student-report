<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 성과 리포트 생성기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { margin:0; padding:15px; background:white!important; font-size:13px; line-height:1.4; }
            .print-bg { background:white!important; box-shadow:none!important; }
            .text-4xl{font-size:26px!important; margin-bottom:10px!important;}
            .text-xl{font-size:16px!important; margin-bottom:18px!important;}
            .text-3xl{font-size:18px!important;}
            .text-2xl{font-size:16px!important;}
            .text-lg{font-size:14px!important;}
            .text-sm{font-size:11px!important;}
            .text-xs{font-size:10px!important;}
            .mb-8{margin-bottom:18px!important;} .mb-6{margin-bottom:15px!important;}
            .mb-4{margin-bottom:12px!important;} .mb-3{margin-bottom:10px!important;}
            .mb-2{margin-bottom:8px!important;} .p-6{padding:15px!important;}
            .gap-8{gap:15px!important;} .gap-6{gap:12px!important;}
            .shadow-lg{box-shadow:none!important;}
            .rounded-lg{border-radius:6px!important; border:1px solid #d1d5db;}
            .stats-grid{display:flex!important; flex-direction:row!important; gap:10px!important; margin-bottom:18px!important;}
            .stats-card{flex:1!important; min-width:0!important; text-align:center!important; padding:12px 10px!important; border:1px solid #d1d5db!important; border-radius:6px!important; background:white!important;}
            .line-chart-container{height:220px!important; margin-bottom:18px!important; padding:10px!important;}
            .chart-container{height:180px!important; margin-bottom:12px!important; padding:5px!important;}
            .pie-charts-grid{display:flex!important; gap:12px!important; margin-bottom:18px!important;}
            .pie-chart-card{flex:1!important; padding:12px!important; border:1px solid #d1d5db!important; border-radius:6px!important; min-height:240px!important;}
            .summary-grid{display:flex!important; gap:15px!important;}
            .summary-column{flex:1!important;}
            .no-break{page-break-inside:avoid!important;}
        }
        .star{color:#fbbf24;} .chart-container{position:relative; height:300px;}
    </style>
</head>
<body class="bg-gray-100">
<div id="app"></div>

<script>
let appState = { studentName:'', rawData:'', parsedData:[], showPreview:false, shareUrl:'', showShareUrl:false };

function loadFromURL() {
    const urlParams=new URLSearchParams(window.location.search);
    const reportData=urlParams.get('report'); const reportId=urlParams.get('id');
    try{
        let decodedData;
        if(reportId){
            const storedData=localStorage.getItem(reportId);
            if(storedData) decodedData=JSON.parse(storedData); else return;
        }else if(reportData){
            decodedData=JSON.parse(atob(reportData));
        }else return;

        if(decodedData.n && decodedData.d){
            appState.studentName=decodedData.n;
            appState.parsedData=decompressData(decodedData.d);
        }else{
            appState.studentName=decodedData.studentName;
            appState.parsedData=decodedData.parsedData;
        }
        appState.showPreview=true;
    }catch(e){ alert('링크가 손상되었거나 만료되었습니다.'); }
}

function parseNotionData(text){
    const lines = text.trim().split('\n');
    const data = [];

    lines.forEach(line => {
        const parts = line.split(/\t+/).map(p => p ? p.trim() : '');
        const date = parts[0] || '';
        const attendance = parts[1] || '';
        const wordScore = parts[2] || '';
        const totalWords = parts[3] || '';
        const retest = parts[4] || '';
        const homeworkRaw = parts[5] || '';
        const attitudeRaw = parts[6] || '';

        const isAbsent = attendance === '결석';

        // 숙제 처리
        let homework = null;      // 통계용 숫자
        let homeworkDisplay = ''; // 화면 표시용

        if (!isAbsent) {
            if (homeworkRaw.includes('★')) {
                // 별점
                homework = (homeworkRaw.match(/★/g) || []).length;
                homeworkDisplay = '★'.repeat(homework) + '☆'.repeat(3 - homework);
            } else if (homeworkRaw === '미제출') {
                homework = 0;           // 통계용 0
                homeworkDisplay = '미제출';
            } else if (homeworkRaw === '지난 시간에는 숙제가 없었습니다.') {
                homework = null;        // 통계 제외
                homeworkDisplay = '';   // 화면에도 표시 X
            } else {
                homework = null;        // 알 수 없는 값도 제외
                homeworkDisplay = homeworkRaw || '';
            }
        }

        // 태도 처리
        let attitude = null;
        if (!isAbsent && attitudeRaw.includes('★')) {
            attitude = (attitudeRaw.match(/★/g) || []).length;
        }

        if(date && attendance){
            data.push({
                date,
                attendance,
                wordScore: !isAbsent && wordScore ? parseInt(wordScore) : null,
                totalWords: !isAbsent && totalWords ? parseInt(totalWords) : null,
                retest: !isAbsent && retest.includes('재시험') ? '재시험' : '',
                homework,
                homeworkDisplay, // 화면 표시용
                attitude
            });
        }
    });

    return data.reverse();
}


function calculateStats(parsedData){
    const totalClasses=parsedData.length;
    const attendanceCount=parsedData.filter(d=>d.attendance==='출석').length;
    const lateCount=parsedData.filter(d=>d.attendance==='지각').length;
    const absentCount=parsedData.filter(d=>d.attendance==='결석').length;
    const attendanceRate=(((attendanceCount+lateCount)/totalClasses)*100).toFixed(1);
    const retestCount=parsedData.filter(d=>d.retest==='재시험').length;

    const chartData=parsedData.map((item,index)=>{
        const accuracy=(item.wordScore!==null && item.totalWords>0)? (item.wordScore/item.totalWords*100):null;
        return {...item, day:index+1, accuracy, shortDate:item.date.substring(5)};
    }).filter(item=>item.accuracy!==null);

    const averageAccuracy=chartData.length>0? chartData.reduce((s,i)=>s+i.accuracy,0)/chartData.length : 0;

    return {totalClasses, attendanceCount, lateCount, absentCount, attendanceRate, retestCount, averageAccuracy, chartData};
}

function compressData(data){
    return data.map(item=>({d:item.date.substring(5), a:item.attendance==='출석'?1: item.attendance==='지각'?2:3, w:item.wordScore, t:item.totalWords, r:item.retest==='재시험'?1:0, h:item.homework, at:item.attitude}));
}
function decompressData(compressed){
    const y=new Date().getFullYear();
    return compressed.map(item=>({date:`${y}/${item.d}`, attendance:item.a===1?'출석': item.a===2?'지각':'결석', wordScore:item.w, totalWords:item.t, retest:item.r===1?'재시험':'', homework:item.h, attitude:item.at }));
}

function createCharts(stats){
    setTimeout(()=>{
        const lineCtx=document.getElementById('lineChart');
        if(lineCtx && stats.chartData.length>0){
            new Chart(lineCtx,{type:'line', data:{
                labels:stats.chartData.map(i=>i.shortDate),
                datasets:[{label:'정답률 (%)', data:stats.chartData.map(i=>i.accuracy), borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.1)', tension:0.3, pointBackgroundColor:'#3b82f6', pointRadius:4}]
            }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{font:{size:12}}}}, scales:{x:{ticks:{font:{size:10}}}, y:{beginAtZero:true,max:100,ticks:{font:{size:10}}}}}});
        }
        const pie=(ctxId,data)=>{ if(!data.length) return; const ctx=document.getElementById(ctxId); if(!ctx)return;
            new Chart(ctx,{type:'pie', data:{labels:data.map(i=>i.label), datasets:[{data:data.map(i=>i.value), backgroundColor:data.map(i=>i.color)}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{font:{size:11}, padding:10}}}}});
        };
        pie('attendanceChart',[{label:'출석',value:stats.attendanceCount,color:'#10b981'},{label:'지각',value:stats.lateCount,color:'#f59e0b'},{label:'결석',value:stats.absentCount,color:'#ef4444'}].filter(i=>i.value>0));
        const hw=appState.parsedData.filter(d=>d.homework!==null);
        pie('homeworkChart',[{label:'미흡 (★☆☆)',value:hw.filter(d=>d.homework===1).length,color:'#ef4444'},{label:'보통 (★★☆)',value:hw.filter(d=>d.homework===2).length,color:'#f59e0b'},{label:'우수 (★★★)',value:hw.filter(d=>d.homework===3).length,color:'#10b981'}].filter(i=>i.value>0));
        const att=appState.parsedData.filter(d=>d.attitude!==null);
        pie('attitudeChart',[{label:'미흡 (★☆☆)',value:att.filter(d=>d.attitude===1).length,color:'#ef4444'},{label:'보통 (★★☆)',value:att.filter(d=>d.attitude===2).length,color:'#f59e0b'},{label:'우수 (★★★)',value:att.filter(d=>d.attitude===3).length,color:'#10b981'}].filter(i=>i.value>0));
    },100);
}

function createStatCard(icon,title,value,subtext,color){
    return `<div class="bg-white rounded-lg shadow-lg p-6 text-center stats-card"><div class="text-${color}-500 mb-3">${icon}</div><h3 class="text-lg font-semibold text-gray-700">${title}</h3><p class="text-3xl font-bold text-${color}-600">${value}</p><p class="text-sm text-gray-500">${subtext||''}</p></div>`;
}
function createPieChartBox(title,canvasId){
    return `<div class="bg-white rounded-lg shadow-lg p-6 pie-chart-card"><h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">${title}</h3><div class="chart-container"><canvas id="${canvasId}"></canvas></div></div>`;
}

function renderReport(stats){
    const summaryCards=`
        ${createStatCard('📅','출석률',`${stats.attendanceRate}%`,`${stats.attendanceCount+stats.lateCount}/${stats.totalClasses}일`,'blue')}
        ${createStatCard('📈','평균 정답률',`${stats.averageAccuracy.toFixed(1)}%`,'단어 테스트','green')}
        ${createStatCard(stats.retestCount>5?'⚠️':'📚','재시험 횟수',`${stats.retestCount}회`,stats.retestCount>5?'개선 필요':'양호',stats.retestCount>5?'red':'blue')}
        ${createStatCard('🏆','종합 평가',stats.overallGrade,stats.overallComment,'purple')}
    `;
    const pieCharts=`
        ${createPieChartBox('출석 현황','attendanceChart')}
        ${createPieChartBox('수업 태도','attitudeChart')}
        ${createPieChartBox('숙제 이행','homeworkChart')}
    `;
    return `
    <div class="no-print fixed top-4 right-4 z-50 space-y-2 bg-white/80 backdrop-blur shadow-lg rounded-lg p-3">
        <div class="flex flex-wrap gap-2">
            <button onclick="resetForm()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                🔄 새 리포트 작성
            </button>
            <button onclick="window.print()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 text-lg font-semibold">
                📄 PDF로 저장하기
            </button>
        </div>
    </div>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 p-6 print-bg">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">학기말 성과 리포트</h1>
                <p class="text-xl text-gray-600">${appState.studentName} 학생 • 2025년 1학기</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 stats-grid no-break">${summaryCards}</div>
            ${stats.chartData.length>0? `<div class="bg-white rounded-lg shadow-lg p-6 mb-8 no-break"><h3 class="text-xl font-semibold text-gray-800 mb-4">단어 테스트 정답률 추이</h3><div class="chart-container line-chart-container"><canvas id="lineChart"></canvas></div></div>`:''}
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8 pie-charts-grid no-break">${pieCharts}</div>
            <div class="bg-white rounded-lg shadow-lg p-6 no-break">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">학기 총평</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 summary-grid">
                    <div class="summary-column">
                        <h4 class="font-semibold text-gray-700 mb-3 text-green-600">강점</h4>
                        <div class="space-y-2 text-gray-700 text-sm">
                            ${stats.attendanceRate>=90? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-3"></span>우수한 출석률 (${stats.attendanceRate}%)</p>`:''}
                            <p class="flex items-center"><span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-3"></span>꾸준한 수업 참여</p>
                        </div>
                    </div>
                    <div class="summary-column">
                        <h4 class="font-semibold text-gray-700 mb-3 text-red-600">개선 필요사항</h4>
                        <div class="space-y-2 text-gray-700 text-sm">
                            ${stats.retestCount>3? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-3"></span>재시험 횟수 줄이기 (${stats.retestCount}회)</p>`:''}
                            ${stats.lateCount>0? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-3"></span>지각 횟수 줄이기 (${stats.lateCount}회)</p>`:''}
                            ${stats.averageAccuracy<80? `<p class="flex items-center"><span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-3"></span>예습·복습을 통한 학습 보완</p>`:''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function render(){
    const app=document.getElementById('app');
    if(appState.showPreview){
        const stats=calculateStats(appState.parsedData);
        stats.overallGrade=stats.averageAccuracy>=85? '우수': stats.averageAccuracy>=70?'보통':'노력';
        stats.overallComment=stats.averageAccuracy>=85? '매우 우수함': stats.averageAccuracy>=70?'꾸준히 향상 중':'개선 필요';
        app.innerHTML=renderReport(stats);
        createCharts(stats);
    }else{
        app.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 p-6">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">학생 성과 리포트 생성기</h1>
                    <p class="text-xl text-gray-600">노션 데이터를 입력하여 자동으로 리포트를 생성하세요</p>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">학생 이름</label>
                            <input type="text" id="studentNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 홍길동">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">노션 데이터 (복사-붙여넣기)</label>
                            <textarea id="rawDataInput" class="w-full h-64 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm" placeholder="예:
2025/08/04	출석	8	8		★★★	★★★
2025/08/01	출석	19	25	재시험	★★★	★★★
2025/07/25	출석	24	25		★★★	★★★"></textarea>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button onclick="handleSubmit()" class="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">👁️ 리포트 생성하기</button>
                        </div>
                    </div>
                    <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">샘플 데이터 (테스트용)</h3>
                        <button onclick="loadSampleData()" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">샘플 데이터 로드</button>
                    </div>
                </div>
            </div>
        </div>`;
    }
}

function handleSubmit(){
    const studentName=document.getElementById('studentNameInput').value;
    const rawData=document.getElementById('rawDataInput').value;
    if(!studentName.trim()){alert('학생 이름을 입력해주세요.');return;}
    if(!rawData.trim()){alert('데이터를 입력해주세요.');return;}
    const parsed=parseNotionData(rawData);
    if(parsed.length===0){alert('데이터 형식을 확인해주세요.');return;}
    appState.studentName=studentName; appState.rawData=rawData; appState.parsedData=parsed; appState.showPreview=true; render();
}
function resetForm(){ appState={studentName:'', rawData:'', parsedData:[], showPreview:false, shareUrl:'', showShareUrl:false}; window.history.pushState({}, document.title, window.location.pathname); render();}
function loadSampleData() {
    document.getElementById('studentNameInput').value = '홍길동';
    document.getElementById('rawDataInput').value = `2025/08/05	지각	18	20		★★☆	★★★
2025/07/24	지각	6	14	재시험	★★★	★★★
2025/07/22	출석	20	20		★☆☆	★★★
2025/07/17	출석	5	14	재시험	★★☆	★★★
2025/07/15	출석	8	20	재시험	★☆☆	★★★
2025/07/10	출석	7	14	재시험	★★☆	★★★
2025/07/08	출석	18	20		★☆☆	★★☆
2025/07/03	출석	14	14		★★★	★★★
2025/07/01	결석					
2025/06/26	출석	14	14		★★★	★★★
2025/06/24	출석	13	20	재시험	★☆☆	★★☆
2025/06/19	출석	10	13	재시험	★★☆	★★★
2025/06/17	출석	10	20	재시험	★☆☆	★★★
2025/06/12	출석	2	13	재시험	★★★	★★☆
2025/06/10	출석	17	20		★☆☆	★★★
2025/06/05	출석	14	14		★☆☆	★★★
2025/06/03	출석				지난 시간에는 숙제가 없었습니다.	★★★`;
}
window.onload=function(){ loadFromURL(); render(); };
</script>
</body>
</html>
